<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="外键," />










<meta name="description" content="​    本文主要讲解了外键的一些基本概念，以及InnoDB下的必要条件，还有外键涉及到的一些表锁定的一些机制，为什么数据库会自动给外键加索引，以及时下具体的使用场景和一些优缺点，本文参考资料见文末。">
<meta property="og:type" content="article">
<meta property="og:title" content="聊聊对于外键的前世今生">
<meta property="og:url" content="http://yoursite.com/2019/07/10/MySQL/%E8%81%8A%E8%81%8A%E5%A4%96%E9%94%AE%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/index.html">
<meta property="og:site_name" content="Billy&#39;s Blog">
<meta property="og:description" content="​    本文主要讲解了外键的一些基本概念，以及InnoDB下的必要条件，还有外键涉及到的一些表锁定的一些机制，为什么数据库会自动给外键加索引，以及时下具体的使用场景和一些优缺点，本文参考资料见文末。">
<meta property="og:image" content="https://i.loli.net/2019/07/10/5d25d9ee459a196196.png">
<meta property="article:published_time" content="2019-07-09T16:00:00.000Z">
<meta property="article:modified_time" content="2020-07-15T07:20:35.283Z">
<meta property="article:author" content="Billy">
<meta property="article:tag" content="外键">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2019/07/10/5d25d9ee459a196196.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/07/10/MySQL/聊聊外键的一些思考/"/>





  <title>聊聊对于外键的前世今生 | Billy's Blog</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Billy's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">仰望星空，脚踏实地</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/home%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20/%E9%A6%96%E9%A1%B5" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags                       //标签"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th             //分类"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive           //归档"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/10/MySQL/%E8%81%8A%E8%81%8A%E5%A4%96%E9%94%AE%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Billy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Billy's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">聊聊对于外键的前世今生</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-10T00:00:00+08:00">
                2019-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Mysql/" itemprop="url" rel="index">
                    <span itemprop="name">Mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计 ">
                   字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                   分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>​    本文主要讲解了<strong>外键的一些基本概念，以及InnoDB下的必要条件，还有外键涉及到的一些表锁定的一些机制，为什么数据库会自动给外键加索引，以及时下具体的使用场景和一些优缺点</strong>，本文参考资料见文末。</p>
<a id="more"></a>
<p>&lt;The rest of contents | 余下全文&gt;</p>
<h4 id="外键的基本概念"><a href="#外键的基本概念" class="headerlink" title="外键的基本概念"></a>外键的基本概念</h4><ol>
<li>外键指定一个字段或字段组合作为一个外键（即外来的主键或唯一键）。</li>
<li>该外键和另一个表的主键或唯一键建立起一个关系。</li>
<li>只能定义为表级约束。</li>
<li>级联关系： 比如说：当客户A删除时，级联删除就会把A的所有订单全删除了，如果不要求级联删除，则只删客户A，而不删除它的订单，这就是级联的作用（包括更新和删除）</li>
</ol>
<h4 id="使用外键的必要条件"><a href="#使用外键的必要条件" class="headerlink" title="使用外键的必要条件"></a>使用外键的必要条件</h4><ol>
<li>两个表存储引擎必须是InnoDB，MyISAM暂时不支持外键</li>
<li>外键列必须建立索引</li>
<li>MySQL 4.1.2以后的版本在建立外键时会自动创建索引，但如果在较早的版本则需要显式建立</li>
<li>外键关系的两表的列的数据类型必须相似，必须是可相互转换类型的列，比如int和tinyint可以，int和char则不可以。</li>
</ol>
<h4 id="使用外键时的表锁定机制——否则数据在父、子表就会存在不一致的情况。"><a href="#使用外键时的表锁定机制——否则数据在父、子表就会存在不一致的情况。" class="headerlink" title="使用外键时的表锁定机制——否则数据在父、子表就会存在不一致的情况。"></a>使用外键时的表锁定机制——否则数据在父、子表就会存在不一致的情况。</h4><ol>
<li>innodb支持外键，但是由于外键，也会对innodb表增加锁定机制；所有的外键相关的操作都在数据更改时，比如检查数据完整性、增加锁定等；</li>
<li>对于外键值的插入或更新，首先需要检查父表中的记录，既SELECT父表。但是对于父表的SELECT操作。</li>
<li>注意不是使用一致性非锁定读的方式，因为这会发生数据不一致的问题，<strong>因此这时使用的是SELECT…LOCK IN SHARE MODE方式（一致性锁定读），即主动对父表加一个S锁。如果这时父表上已经这样加X锁</strong>，子表上的操作会被阻塞。</li>
</ol>
<p><img src="https://i.loli.net/2019/07/10/5d25d9ee459a196196.png" alt=""></p>
<p>​    在上述的例子中，两个会话中的事务都没有进行COMMIT或ROLLBACK操作，而会话B的操作会被阻塞。这是因为tag_id为3的父表在会话中已经加了一个X锁，而此时在会话B中用户又需要对父表中tag_id为3的行加一个S锁，这时INSERT的操作会被阻塞。</p>
<p>​    <strong>设想如果访问父表时，使用的是一致性的非锁定读，这时Session B会读到父表有tag_id=3的记录，可以进行插入操作。但是如果会话A对事务提交了，则父表中就不存在tag_id为3的记录。数据在父、子表就会存在不一致的情况。</strong></p>
<h5 id="一些具体的具体例子"><a href="#一些具体的具体例子" class="headerlink" title="一些具体的具体例子"></a>一些具体的具体例子</h5><ol>
<li>假设一个表为 parent ，一个表为child，parent通过id和child的parent_id相连接；在一个session中set autocommit=0，执行对parent或child的操作，在另一个session执行对child或parent的操作，从而得出以下结论：</li>
</ol>
<h5 id="（1）对父表的操作"><a href="#（1）对父表的操作" class="headerlink" title="（1）对父表的操作"></a>（1）对父表的操作</h5><ul>
<li>insert to parent，新插入行的id值为XXX。child会锁外键值为XXX的行,不会锁其他行</li>
</ul>
<ul>
<li>update parent，原id为XXX，现id为YYY。child会锁外键值为XXX,YYY的行,不会锁其他行</li>
</ul>
<ul>
<li>delete from parent，删除行的id为XXX。child会锁外键值为XXX,不会锁其他行</li>
</ul>
<h5 id="（2）对子表的操作"><a href="#（2）对子表的操作" class="headerlink" title="（2）对子表的操作"></a>（2）对子表的操作</h5><ul>
<li><p>insert to child，插入行的外键值为XXX。parent会锁值XXX的行,不会锁其他行</p>
</li>
<li><p>update child，更新行的外键值原为XXX，现为YYY。parent会锁XXX,YYY行,但要注意:存在间隔锁,也会锁其他行(XXX,YYY之间的位置)</p>
</li>
<li><p>delete from child，删除行的外键值为XXX 。parent会锁XXX的行,但要注意:存在间隔锁,也会锁其他行(XXX-1的位置)</p>
</li>
</ul>
<h4 id="为什么Mysql要自动给外键加上索引"><a href="#为什么Mysql要自动给外键加上索引" class="headerlink" title="为什么Mysql要自动给外键加上索引"></a>为什么Mysql要自动给外键加上索引</h4><blockquote>
<p> 首先是朋友遇到的问题，如果（父表）字段没有索引，创建外键会失败。于是，就引出一个MySQL创建外键关系的重要条件：</p>
<p><strong>父表关联字段必须显式创建索引（单字段索引或位于最左位置的组合索引）；子表外键字段也是索引字段（如果不是索引字段建立外键关系的时候MySQL会隐式地为该字段创建一个普通索引）。即外键相关字段最后一定会是索引字段。</strong>这里对此过程和结论再做一个简单验证。</p>
</blockquote>
<p>①首先创建一张示意父表和一张示意子表，其中父表没有索引（甚至没有主键）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE `tab_father` (</span><br><span class="line">    -&gt; `pk_left` INT(11) UNSIGNED NOT NULL,</span><br><span class="line">    -&gt; `pk_right` INT(11) UNSIGNED NOT NULL,</span><br><span class="line">    -&gt; `ts` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP</span><br><span class="line">    -&gt; )</span><br><span class="line">    -&gt; COLLATE='utf8_general_ci'</span><br><span class="line">    -&gt; ENGINE=InnoDB</span><br><span class="line">    -&gt; ;</span><br><span class="line">Query OK, 0 rows affected (0.12 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE `tab_child` (</span><br><span class="line">    -&gt; `id` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,</span><br><span class="line">    -&gt; `col` INT(10) UNSIGNED NOT NULL,</span><br><span class="line">    -&gt; PRIMARY KEY (`id`)</span><br><span class="line">    -&gt; )</span><br><span class="line">    -&gt; COLLATE='utf8_general_ci'</span><br><span class="line">    -&gt; ENGINE=InnoDB</span><br><span class="line">    -&gt; ;</span><br><span class="line">Query OK, 0 rows affected (1.09 sec)</span><br></pre></td></tr></table></figure>

<p>②子表<code>col</code>字段关联父表<code>pk_right</code>字段 → 失败</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER TABLE `tab_child`</span><br><span class="line">    -&gt; ADD CONSTRAINT `FK_tab_child_tab_father` FOREIGN KEY (`col`) REFERENCES `tab_father` (`pk_right`) ON UPDATE CASCADE ON DELETE CASCADE;</span><br><span class="line">ERROR 1215 (HY000): Cannot add foreign key constraint</span><br></pre></td></tr></table></figure>

<p>③为父表<code>pk_right</code>字段显式创建索引再创建外键 → 成功</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER TABLE `tab_father`</span><br><span class="line">    -&gt; ADD INDEX `pk_right` (`pk_right`);</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"> </span><br><span class="line">mysql&gt; </span><br><span class="line">mysql&gt; ALTER TABLE `tab_child`</span><br><span class="line">    -&gt; ADD CONSTRAINT `FK_tab_child_tab_father` FOREIGN KEY (`col`) REFERENCES `tab_father` (`pk_right`) ON UPDATE CASCADE ON DELETE CASCADE;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure>

<p>此时再翻过来看一下，子表的<code>col</code>字段也已经是索引字段了（MySQL隐式创建）。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT c.TABLE_NAME, c.COLUMN_NAME, c.COLUMN_KEY</span><br><span class="line">    -&gt; FROM information_schema.`COLUMNS` c</span><br><span class="line">    -&gt; WHERE c.TABLE_NAME = 'tab_child'</span><br><span class="line">    -&gt; AND c.COLUMN_NAME = 'col';</span><br><span class="line">+<span class="comment">------------+-------------+------------+</span></span><br><span class="line">| TABLE_NAME | COLUMN_NAME | COLUMN_KEY |</span><br><span class="line">+<span class="comment">------------+-------------+------------+</span></span><br><span class="line">| tab_child  | col         | MUL        |</span><br><span class="line">+<span class="comment">------------+-------------+------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>④初始化父表和子表，为父表创建联合主键；为子表创建一个唯一索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER TABLE `tab_child`</span><br><span class="line">    -&gt; DROP FOREIGN KEY `FK_tab_child_tab_father`;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"> </span><br><span class="line">mysql&gt; ALTER TABLE `tab_child`</span><br><span class="line">    -&gt; DROP INDEX `FK_tab_child_tab_father`;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"> </span><br><span class="line">mysql&gt; ALTER TABLE `tab_child`</span><br><span class="line">    -&gt; ADD UNIQUE INDEX `col` (`col`);</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"> </span><br><span class="line">mysql&gt; ALTER TABLE `tab_father`</span><br><span class="line">    -&gt; DROP INDEX `pk_right`;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"> </span><br><span class="line">mysql&gt; ALTER TABLE `tab_father`</span><br><span class="line">    -&gt; ADD PRIMARY KEY (`pk_left`, `pk_right`);</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure>

<p>⑤关联父表联合主键第二字段创建外键 → 失败。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER TABLE `tab_child`</span><br><span class="line">    -&gt; ADD CONSTRAINT `FK_tab_child_tab_father` FOREIGN KEY (`col`) REFERENCES `tab_father` (`pk_right`) ON UPDATE CASCADE ON DELETE CASCADE;</span><br><span class="line">ERROR 1215 (HY000): Cannot add foreign key constraint</span><br></pre></td></tr></table></figure>

<p>⑥关联父表联合主键第一字段创建外键 → 成功。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER TABLE &#96;tab_child&#96;</span><br><span class="line">    -&gt; ADD CONSTRAINT &#96;FK_tab_child_tab_father&#96; FOREIGN KEY (&#96;col&#96;) REFERENCES &#96;tab_father&#96; (&#96;pk_left&#96;) ON UPDATE CASCADE ON DELETE CASCADE;</span><br><span class="line">Query OK, 0 rows affected (0.06 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure>

<h5 id="加索引的主要原因"><a href="#加索引的主要原因" class="headerlink" title="加索引的主要原因"></a>加索引的主要原因</h5><blockquote>
<p>主要原因就在于查询性能了。父子表之间在进行外键检查时，需要一条一条每条必查地校验，即全表扫描，而且在对父表的SELECT操作时，为了避免产出数据不一致，使用的是一致性锁定读（SELECT …… LOCK IN SHARE MODE），主动加一个S锁阻塞其他的修改操作。如果没有索引，对于大一点的表而言那效率就非常低下了</p>
</blockquote>
<h5 id="为什么子表可以隐式地创建索引而父表需要显式地创建"><a href="#为什么子表可以隐式地创建索引而父表需要显式地创建" class="headerlink" title="为什么子表可以隐式地创建索引而父表需要显式地创建"></a>为什么子表可以隐式地创建索引而父表需要显式地创建</h5><p>那么，就有另外一个问题了，<strong>为什么子表可以隐式地创建索引而父表需要显式地创建</strong>？这也就是博文开篇所言的没有完整解决的问题。按照个人理解可能存在以下方面的考虑吧。</p>
<p><strong>同样是性能原因考虑。</strong></p>
<blockquote>
<p>这里就涉及到MySQL创建外键的执行过程。按照上文的测试用例，可能会走这么一个流程（伪过程：具体先后顺序应该会有所出入）。</p>
<p>A.检查父表关联字段有没有创建可使用的有效索引（if not raise an err）；</p>
<p>B.检查子表父表字段属性的一致性，包括数据类型、长度、字符编码等（if not raise an err）；</p>
<p>C.检查子表外键字段是否创建索引（if not create it）；</p>
<p>D.（如果子表有数据则进行）检查子表数据是否关联父表记录（if not raise an err and rollback the created index on child table）。</p>
<p>由此可见，创建外键关联一句简单的SQL，MySQL要做包括潜在的DDL、DQL在内的很多工作。从MySQL5.6开始，即便引进了Online DDL，以使得一些包括创建辅助索引（secondary index）在内的表结构修改的性能大大提高，但如果父子表字段都没有创建索引，而同时为父子表创建索引依然是非常低效的，而且如果到了Step D 回退两张表的索引创建又是很不值得的。</p>
</blockquote>
<p><strong>父表操作权限限制。</strong></p>
<blockquote>
<p>对于权限控制级别比较高的项目，并不是每个user都有每张table的所有privilege。当对子表创建外键时，也就暗示该用户已经拥有子表创建索引的权限。所以，MySQL可以静默地帮助顺便创建一个索引。与此同时，父表有没有修改表结构的权限就不得而知了。MySQL为了避免多一步权限检查的麻烦，就干脆放弃对父表也隐式创建索引的包办。</p>
</blockquote>
<h4 id="外键的优缺点"><a href="#外键的优缺点" class="headerlink" title="外键的优缺点"></a>外键的优缺点</h4><h5 id="（1）优点"><a href="#（1）优点" class="headerlink" title="（1）优点"></a>（1）优点</h5><ul>
<li>保证数据的完整性和一致性</li>
<li>级联操作方便</li>
<li>将数据完整性判断托付给了数据库完成，减少了程序的代码量</li>
</ul>
<h5 id="（2）缺点"><a href="#（2）缺点" class="headerlink" title="（2）缺点"></a>（2）缺点</h5><p>​    外键是能够保证数据的完整性，但是会给系统带来很多缺陷。正是因为这些缺陷，才导致我们不推荐使用外键，具体如下</p>
<ol>
<li><p><strong>性能问题</strong><br> 假设一张表名为user_tb。那么这张表里有两个外键字段，指向两张表。那么，每次往user_tb表里插入数据，就必须往两个外键对应的表里查询是否有对应数据。如果交由程序控制，这种查询过程就可以控制在我们手里，可以省略一些不必要的查询过程。但是如果由数据库控制，则是必须要去这两张表里判断。</p>
</li>
<li><p><strong>并发问题</strong><br> 在使用外键的情况下，每次修改数据都需要去另外一个表检查数据,需要获取额外的锁。若是在高并发大流量事务场景，使用外键更容易造成死锁。</p>
</li>
<li><p><strong>扩展性问题</strong><br> 这里主要是分为两点</p>
</li>
</ol>
<ul>
<li>做平台迁移方便，比如你从Mysql迁移到Oracle，像触发器、外键这种东西，都可以利用框架本身的特性来实现，而不用依赖于数据库本身的特性，做迁移更加方便。</li>
<li>分库分表方便，在水平拆分和分库的情况下，外键是无法生效的。将数据间关系的维护，放入应用程序中，为将来的分库分表省去很多的麻烦</li>
</ul>
<h4 id="具体的使用场景"><a href="#具体的使用场景" class="headerlink" title="具体的使用场景"></a>具体的使用场景</h4><h5 id="阿里的规范：不得使用外键与级联，一切外键概念必须在应用层解决"><a href="#阿里的规范：不得使用外键与级联，一切外键概念必须在应用层解决" class="headerlink" title="阿里的规范：不得使用外键与级联，一切外键概念必须在应用层解决"></a>阿里的规范：不得使用外键与级联，一切外键概念必须在应用层解决</h5><blockquote>
<p>【强制】不得使用外键与级联，一切外键概念必须在应用层解决。</p>
<p>说明：以学生和成绩的关系为例，学生表中的 student_id是主键，那么成绩表中的 student_id 则为外键。如果更新学生表中的 student_id，同时触发成绩表中的 student_id 更新，即为 级联更新。外键与级联更新适用于单机低并发，不适合分布式、高并发集群；级联更新是强阻塞，存在数据库更新风暴的风险；外键影响数据库的插入速度。</p>
</blockquote>
<p>但是呢，询问他们原因，大多是这么回答的</p>
<p><strong>每次做DELETE 或者UPDATE都必须考虑外键约束，会导致开发的时候很痛苦,测试数据极为不方便。</strong></p>
<h5 id="mysqlops的回答"><a href="#mysqlops的回答" class="headerlink" title="@mysqlops的回答"></a>@<a href="https://www.zhihu.com/people/mysqlops" target="_blank" rel="noopener">mysqlops</a>的回答</h5><ol>
<li>互联网行业应用不推荐使用外键： <ul>
<li>用户量大，并发度高，为此数据库服务器很容易成为性能瓶颈，尤其受IO能力限制，且不能轻易地水平扩展；若是把数据一致性的控制放到事务中，也即让应用服务器承担此部分的压力，而引用服务器一般都是可以做到轻松地水平的伸缩；</li>
</ul>
</li>
<li>传统行业<ul>
<li>软件应用的人数有限，换句话说是可控的；</li>
<li>数据库服务器的数据量也一般不会超大，且活跃数据有限；</li>
</ul>
</li>
</ol>
<p>综合上述2句话描述，</p>
<ul>
<li><strong>也即数据库服务器的性能不是问题，所以不用过多考虑性能的问题；</strong></li>
<li><strong>另外，使用外键可以降低开发成本，借助数据库产品自身的触发器可以实现表与关联表之间的数据一致性和更新；</strong></li>
<li><strong>最后一点，使用外键的方式，还可以做到开发人员和数据库设计人员的分工，可以为程序员承担更多的工作量；</strong></li>
</ul>
<p>为何说外键有性能问题：</p>
<ul>
<li>1.数据库需要维护外键的内部管理；</li>
<li>2.外键等于把数据的一致性事务实现，全部交给数据库服务器完成；</li>
<li>3.有了外键，当做一些涉及外键字段的增，删，更新操作之后，需要触发相关操作去检查，而不得不消耗资源；</li>
<li>4.外键还会因为需要请求对其他表内部加锁而容易出现死锁情况；</li>
</ul>
<h4 id="存在的疑问："><a href="#存在的疑问：" class="headerlink" title="存在的疑问："></a>存在的疑问：</h4><ul>
<li><input disabled="" type="checkbox"> 级联更新是强阻塞，存在数据库更新风暴的风险</li>
<li><input disabled="" type="checkbox"> 强阻塞和更新风暴的概念</li>
<li><input disabled="" type="checkbox"> 外键造成死锁</li>
</ul>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><p><a href="https://blog.csdn.net/sweeper_freedoman/article/details/61426736" target="_blank" rel="noopener">https://blog.csdn.net/sweeper_freedoman/article/details/61426736</a></p>
<p><a href="https://blog.csdn.net/gaohuanjie/article/details/86157192" target="_blank" rel="noopener">https://blog.csdn.net/gaohuanjie/article/details/86157192</a></p>
<p><a href="https://blog.csdn.net/gtuu0123/article/details/5651039" target="_blank" rel="noopener">https://blog.csdn.net/gtuu0123/article/details/5651039</a> </p>
<p><a href="http://www.mysqlperformanceblog.com/2006/12/12/innodb-locking-and-foreign-keys/" target="_blank" rel="noopener">http://www.mysqlperformanceblog.com/2006/12/12/innodb-locking-and-foreign-keys/</a></p>
<p><a href="https://www.cnblogs.com/rjzheng/p/9907304.html" target="_blank" rel="noopener">https://www.cnblogs.com/rjzheng/p/9907304.html</a></p>
<p><a href="https://www.zhihu.com/question/19600081/answer/13295957" target="_blank" rel="noopener">https://www.zhihu.com/question/19600081/answer/13295957</a></p>
<p>《Mysql-InnoDB 技术内幕》</p>
<p>​    </p>

      
    </div>
    
    
    

    

    

    
<div>
    
      <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文已完结，撒花~<i class="fa fa-paw"></i>~感谢您的阅读-------------</div>
    
</div>
    
</div>
    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E5%A4%96%E9%94%AE/" rel="tag"># 外键</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/08/MySQL/Mysql%E5%BD%93%E4%B8%AD%E7%9A%84%E9%94%81(%E4%BA%94)/" rel="next" title="InnoDB引擎当中的锁 —— 锁的几种算法与幻读">
                <i class="fa fa-chevron-left"></i> InnoDB引擎当中的锁 —— 锁的几种算法与幻读
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Billy" />
            
              <p class="site-author-name" itemprop="name">Billy</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive%20%20%20%20%20%20%20%20%20%20%20/%E5%BD%92%E6%A1%A3">
              
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/KeepHot" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github-alt"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/u/6076021248" target="_blank" title="微博">
                      
                        <i class="fa fa-fw fa-weibo"></i>微博</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/liu-quan-7-71/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-angellist"></i>知乎</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:billy9h3@163.com" target="_blank" title="E-mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友链
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.hollischuang.com/" title="Hollis" target="_blank">Hollis</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.iocoder.cn/?csdn" title="芋道源码" target="_blank">芋道源码</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://ifeve.com/" title="并发编程网" target="_blank">并发编程网</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://tech.meituan.com/" title="美团技术团队" target="_blank">美团技术团队</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://cmsblogs.com/" title="Java技术驿站" target="_blank">Java技术驿站</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://colobu.com/" title="鸟窝" target="_blank">鸟窝</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://coolshell.cn/" title="酷壳" target="_blank">酷壳</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#外键的基本概念"><span class="nav-number">1.</span> <span class="nav-text">外键的基本概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用外键的必要条件"><span class="nav-number">2.</span> <span class="nav-text">使用外键的必要条件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用外键时的表锁定机制——否则数据在父、子表就会存在不一致的情况。"><span class="nav-number">3.</span> <span class="nav-text">使用外键时的表锁定机制——否则数据在父、子表就会存在不一致的情况。</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#一些具体的具体例子"><span class="nav-number">3.1.</span> <span class="nav-text">一些具体的具体例子</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#（1）对父表的操作"><span class="nav-number">3.2.</span> <span class="nav-text">（1）对父表的操作</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#（2）对子表的操作"><span class="nav-number">3.3.</span> <span class="nav-text">（2）对子表的操作</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#为什么Mysql要自动给外键加上索引"><span class="nav-number">4.</span> <span class="nav-text">为什么Mysql要自动给外键加上索引</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#加索引的主要原因"><span class="nav-number">4.1.</span> <span class="nav-text">加索引的主要原因</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#为什么子表可以隐式地创建索引而父表需要显式地创建"><span class="nav-number">4.2.</span> <span class="nav-text">为什么子表可以隐式地创建索引而父表需要显式地创建</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#外键的优缺点"><span class="nav-number">5.</span> <span class="nav-text">外键的优缺点</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#（1）优点"><span class="nav-number">5.1.</span> <span class="nav-text">（1）优点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#（2）缺点"><span class="nav-number">5.2.</span> <span class="nav-text">（2）缺点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#具体的使用场景"><span class="nav-number">6.</span> <span class="nav-text">具体的使用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#阿里的规范：不得使用外键与级联，一切外键概念必须在应用层解决"><span class="nav-number">6.1.</span> <span class="nav-text">阿里的规范：不得使用外键与级联，一切外键概念必须在应用层解决</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysqlops的回答"><span class="nav-number">6.2.</span> <span class="nav-text">@mysqlops的回答</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#存在的疑问："><span class="nav-number">7.</span> <span class="nav-text">存在的疑问：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参考资料"><span class="nav-number">8.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Billy</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
